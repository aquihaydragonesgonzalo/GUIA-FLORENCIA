
<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Florencia 2026 | Guía PWA</title>
    
    <meta name="theme-color" content="#881337">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Guía personalizada para la escala en Florencia 2026">
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjvVYlm-4zLxbxXytfjaMND4HGRSzqyWMEewJl-tKAd8Qs28rFd411YMWOfAV2YJu-IqqOB3KaBEw_0rFxpoFHCLiAHn7ZtqoxNYG1bZVZ4U7Q4cuIV9V-XU8JiyyT6aigIB0UJLpeWu4fXhfcQ_6nbrXd84YPRd7dZ8q1STw-rLcfTdkCTa5oAoPuTPZ8/s320/Gemini_Generated_Image_l4457il4457il445.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        firenze: { 
                          50: '#fff1f2', 100: '#ffe4e6', 200: '#fecdd3', 300: '#fda4af', 
                          400: '#fb7185', 500: '#f43f5e', 600: '#e11d48', 700: '#be123c', 
                          800: '#9f1239', 900: '#881337', 950: '#4c0519' 
                        }
                    },
                    fontFamily: {
                        sans: ['Roboto Condensed', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overscroll-behavior-y: none; background-color: #fafaf9; }
        body { font-family: 'Roboto Condensed', sans-serif; -webkit-tap-highlight-color: transparent; }
        #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-h-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-h-scrollbar::-webkit-scrollbar-track { background: #f5f5f4; border-radius: 10px; }
        .custom-h-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }

        .leaflet-bottom { bottom: 85px !important; }
        
        #initial-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #881337; display: flex; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.4s ease-out;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Leaflet JS Global -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "leaflet": "https://esm.sh/leaflet@^1.9.4"
  }
}
</script>
</head>
<body>
    <div id="initial-loader">
        <div style="text-align: center; color: white;">
            <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 15px;"></div>
            <p style="font-weight: bold; letter-spacing: 1.5px; font-size: 11px; text-transform: uppercase; opacity: 0.8;">Iniciando Guía Florencia</p>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } = Recharts;

        // --- ICONS (SVG Inlined for Performance/Compatibility) ---
        const Icon = ({ path, className, size = 24, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Anchor: (p) => <Icon {...p} path={<><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></>} />,
            CalendarClock: (p) => <Icon {...p} path={<><path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h5"/><path d="M21 17a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/><path d="M17 15v2l1.5 1.5"/></>} />,
            Map: (p) => <Icon {...p} path={<><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></>} />,
            Wallet: (p) => <Icon {...p} path={<><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></>} />,
            BookOpen: (p) => <Icon {...p} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            CheckCircle2: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />,
            Circle: (p) => <Icon {...p} path={<circle cx="12" cy="12" r="10"/>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            MapPin: (p) => <Icon {...p} path={<><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></>} />,
            Navigation: (p) => <Icon {...p} path={<polygon points="3 11 22 2 13 21 11 13 3 11"/>} />,
            Headphones: (p) => <Icon {...p} path={<><path d="M3 14v-3a9 9 0 0 1 18 0v3"/><path d="M2 19h3a1 1 0 0 0 1-1v-5.5a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v5.5a1 1 0 0 0 1 1Z"/><path d="M22 19h-3a1 1 0 0 1-1-1v-5.5a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v5.5a1 1 0 0 1-1 1Z"/></>} />,
            Ticket: (p) => <Icon {...p} path={<><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></>} />,
            ExternalLink: (p) => <Icon {...p} path={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></>} />,
            AlertTriangle: (p) => <Icon {...p} path={<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 18 18"/></>} />,
            Play: (p) => <Icon {...p} path={<polygon points="5 3 19 12 5 21 5 3"/>} />,
            Square: (p) => <Icon {...p} path={<rect width="18" height="18" x="3" y="3" rx="2" />} />,
            Info: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></>} />,
            TrendingDown: (p) => <Icon {...p} path={<polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/>} />,
            Thermometer: (p) => <Icon {...p} path={<path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/>} />,
            PhoneCall: (p) => <Icon {...p} path={<><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/><path d="M14.05 2a9 9 0 0 1 8 7.94"/><path d="M14.05 6A5 5 0 0 1 18 10"/></>} />,
            Send: (p) => <Icon {...p} path={<><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />,
            Languages: (p) => <Icon {...p} path={<><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></>} />,
            Volume2: (p) => <Icon {...p} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></>} />,
            Activity: (p) => <Icon {...p} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>} />,
            Sun: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>} />,
            Cloud: (p) => <Icon {...p} path={<path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19h-4a5 5 0 1 1 9.9-2 5 5 0 0 1 9.9 2h-4.8z"/>} />,
            CloudRain: (p) => <Icon {...p} path={<><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 20v-4"/><path d="M8 20v-4"/><path d="M12 20v-4"/></>} />,
            CloudLightning: (p) => <Icon {...p} path={<><path d="M6 16.326A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 .5 8.973"/><path d="m13 12-3 5h4l-3 5"/></>} />,
            Wind: (p) => <Icon {...p} path={<><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></>} />,
            Footprints: (p) => <Icon {...p} path={<><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-.51 2-1.25 2H6.88c-.66 0-1.2.55-1.2 1.2 0 .65.55 1.2 1.2 1.2H10c1.66 0 3 1.34 3 3v2c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2v-1"/><path d="M14 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C8.63 6 7 7.8 7 12c0 1.25.51 2 1.25 2h2.87c.66 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2H8c-1.66 0-3 1.34-3 3v2c0 1.1.9 2 2 2h3c1.1 0 2-.9 2-2v-1"/></>} />,
            CalendarDays: (p) => <Icon {...p} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></>} />,
        };

        // --- CONSTANTS ---
        const SHIP_DEPARTURE_TIME = "20:00";
        const SHIP_ONBOARD_TIME = "19:30";
        const DATE_OF_VISIT = "2026-04-15";

        const GPX_WAYPOINTS = [
            { name: "Estación Santa Maria Novella", lat: 43.776539, lng: 11.248277 },
            { name: "Basilica de San Lorenzo", lat: 43.774947, lng: 11.253846 },
            { name: "Capilla de los Medici", lat: 43.775039, lng: 11.253357 },
            { name: "Galería de la Academia", lat: 43.776901, lng: 11.258696 },
            { name: "Duomo y Baptisterio", lat: 43.773127, lng: 11.255386 },
            { name: "Santa Maria de las Flores", lat: 43.773127, lng: 11.256944 },
            { name: "Piazza della Signoria", lat: 43.769713, lng: 11.255829 },
            { name: "Palazzo Vecchio", lat: 43.769278, lng: 11.255947 },
            { name: "Loggia dei Lanzi", lat: 43.769244, lng: 11.255556 },
            { name: "Puente Vecchio", lat: 43.76795, lng: 11.253097 },
            { name: "Palazzo Pitti", lat: 43.765294, lng: 11.249918 },
            { name: "Estación Livorno", lat: 43.554202, lng: 10.33564 },
            { name: "Shuttle Bus (Livorno)", lat: 43.551830, lng: 10.308315 }
        ];

        const FLORENCE_WALK_TRACK = [
            [43.776531, 11.249154], [43.776698, 11.249086], [43.776736, 11.24907], [43.776755, 11.249145], 
            [43.776779, 11.249237], [43.776783, 11.249253], [43.776788, 11.249272], [43.776798, 11.249313], 
            [43.776803, 11.249334], [43.776812, 11.249369], [43.77678, 11.249382], [43.776305, 11.249569], 
            [43.776265, 11.249581], [43.775923, 11.24968], [43.775806, 11.24972], [43.775764, 11.249736], 
            [43.775298, 11.249946], [43.775089, 11.250034], [43.775089, 11.250034], [43.77511, 11.25013], 
            [43.775258, 11.250764], [43.775174, 11.250857], [43.775161, 11.250871], [43.775154, 11.250878], 
            [43.774821, 11.25123], [43.774812, 11.25123], [43.774811, 11.251259], [43.774787, 11.252249], 
            [43.774801, 11.25225], [43.774801, 11.252273], [43.774801, 11.252286], [43.7748, 11.252301], 
            [43.774775, 11.252324], [43.774785, 11.252452], [43.774969, 11.252737], [43.774963, 11.252741], 
            [43.774957, 11.252745], [43.775116, 11.25299], [43.775091, 11.253019], [43.775109, 11.253043], 
            [43.775076, 11.253071], [43.7751, 11.253079], [43.775122, 11.253155], [43.775132, 11.253147], 
            [43.775216, 11.253341], [43.77519, 11.253368], [43.775204, 11.253406], [43.775191, 11.253474], 
            [43.775165, 11.253497], [43.775182, 11.25354], [43.775025, 11.253656], [43.775134, 11.253679], 
            [43.775265, 11.253729], [43.775303, 11.25376], [43.775275, 11.253924], [43.775178, 11.253891], 
            [43.77515, 11.254051], [43.775089, 11.254025], [43.775082, 11.254049], [43.775054, 11.25404], 
            [43.775005, 11.254306], [43.774945, 11.254638], [43.77474, 11.254571], [43.774658, 11.254535], 
            [43.774656, 11.254554], [43.774641, 11.254549], [43.774586, 11.254952], [43.774583, 11.254977], 
            [43.77458, 11.254997], [43.775005, 11.255147], [43.775012, 11.255151], [43.774828, 11.255726], 
            [43.774789, 11.255849], [43.774859, 11.255899], [43.775407, 11.256287], [43.775801, 11.256577], 
            [43.776674, 11.257263], [43.776709, 11.25729], [43.776729, 11.257305], [43.776705, 11.257371], 
            [43.776366, 11.258173], [43.776352, 11.258207], [43.776512, 11.258333], [43.776504, 11.258353], 
            [43.776993, 11.258731], [43.776994, 11.258732], [43.776504, 11.258353], [43.776512, 11.258333], 
            [43.776352, 11.258207], [43.776308, 11.258173], [43.774519, 11.256796], [43.774485, 11.25677], 
            [43.774469, 11.256756], [43.774459, 11.256748], [43.774434, 11.256726], [43.774341, 11.256646], 
            [43.773497, 11.256006], [43.773433, 11.255959], [43.773442, 11.255412], [43.773463, 11.255338], 
            [43.773436, 11.255321], [43.773418, 11.255309], [43.773393, 11.255266], [43.773411, 11.255068], 
            [43.773448, 11.254654], [43.773176, 11.254614], [43.773135, 11.254614], [43.773135, 11.254614], 
            [43.773176, 11.254614], [43.773448, 11.254654], [43.773411, 11.255068], [43.773393, 11.255266], 
            [43.773418, 11.255309], [43.773436, 11.255321], [43.773463, 11.255338], [43.773442, 11.255412], 
            [43.773433, 11.255959], [43.773424, 11.256546], [43.773591, 11.256796], [43.77361, 11.256853], 
            [43.773614, 11.256865], [43.773607, 11.257088], [43.773533, 11.257194], [43.773425, 11.257347], 
            [43.773199, 11.25761], [43.773079, 11.25767], [43.772886, 11.257744], [43.772579, 11.257831], 
            [43.772564, 11.257833], [43.772579, 11.257831], [43.772597, 11.257333], [43.772606, 11.25681], 
            [43.7727, 11.256564], [43.772706, 11.256308], [43.772718, 11.255851], [43.772718, 11.255822], 
            [43.772729, 11.255379], [43.772723, 11.255378], [43.772621, 11.255374], [43.772499, 11.255369], 
            [43.772245, 11.255359], [43.772215, 11.255358], [43.772181, 11.255357], [43.771554, 11.255332], 
            [43.771514, 11.25533], [43.771471, 11.255328], [43.771236, 11.255317], [43.770864, 11.255304], 
            [43.770596, 11.255294], [43.770573, 11.255293], [43.770213, 11.255279], [43.770013, 11.255272], 
            [43.770002, 11.255276], [43.769887, 11.255296], [43.769848, 11.25544], [43.769395, 11.255371], 
            [43.769317, 11.255591], [43.769317, 11.255591], [43.769223, 11.255859], [43.769177, 11.255845], 
            [43.769157, 11.255837], [43.769133, 11.255827], [43.769119, 11.255872], [43.769088, 11.255857], 
            [43.769073, 11.25585], [43.768519, 11.25559], [43.767863, 11.255292], [43.767852, 11.255286], 
            [43.767764, 11.255246], [43.767749, 11.255238], [43.767745, 11.255236], [43.767797, 11.255029], 
            [43.76795, 11.254796], [43.76801, 11.254686], [43.768038, 11.25462], [43.768045, 11.254603], 
            [43.768333, 11.253851], [43.768396, 11.253695], [43.768427, 11.253619], [43.768466, 11.253503], 
            [43.768428, 11.253481], [43.768405, 11.253468], [43.767844, 11.253048], [43.767845, 11.253049], 
            [43.767603, 11.252867], [43.767517, 11.252807], [43.767527, 11.252783], [43.767465, 11.252732], 
            [43.767386, 11.252665], [43.767367, 11.252644], [43.767204, 11.252356], [43.767166, 11.252275], 
            [43.767119, 11.252171], [43.767017, 11.251928], [43.766832, 11.251495], [43.766707, 11.251225], 
            [43.766629, 11.251081], [43.766576, 11.250981], [43.766506, 11.250877], [43.766479, 11.250843], 
            [43.766452, 11.250809], [43.766384, 11.25075], [43.766326, 11.250703], [43.766231, 11.250538], 
            [43.766126, 11.250346], [43.766104, 11.250294], [43.766001, 11.25007], [43.765856, 11.249752], 
            [43.765785, 11.249603], [43.765754, 11.249539], [43.76573, 11.24956], [43.765705, 11.249583], 
            [43.765469, 11.249776], [43.765705, 11.249583], [43.76573, 11.24956], [43.765754, 11.249539], 
            [43.765785, 11.249603], [43.765856, 11.249752], [43.765918, 11.249692], [43.76602, 11.249592], 
            [43.766094, 11.249499], [43.766107, 11.249482], [43.766545, 11.248898], [43.766552, 11.248888], 
            [43.766581, 11.24885], [43.766543, 11.24883], [43.76656, 11.248786], [43.766638, 11.248585], 
            [43.766735, 11.248335], [43.766747, 11.248304], [43.767268, 11.248709], [43.767298, 11.248623], 
            [43.767174, 11.248531], [43.767298, 11.248623], [43.767268, 11.248709], [43.767421, 11.24883], 
            [43.767496, 11.248925], [43.768031, 11.249412], [43.768187, 11.249545], [43.768197, 11.249554], 
            [43.768186, 11.249646], [43.768185, 11.249653], [43.768169, 11.249779], [43.76821, 11.249802], 
            [43.768519, 11.249975], [43.768549, 11.249979], [43.768578, 11.250011], [43.768603, 11.250027], 
            [43.768643, 11.250022], [43.768652, 11.250028], [43.769444, 11.250584], [43.769472, 11.250605], 
            [43.769479, 11.25061], [43.769502, 11.250629], [43.769486, 11.250665], [43.769512, 11.25069], 
            [43.769518, 11.250695], [43.769987, 11.251069], [43.770049, 11.251119], [43.770225, 11.251257], 
            [43.770283, 11.251303], [43.770335, 11.251341], [43.77071, 11.251373], [43.771466, 11.251361], 
            [43.771515, 11.251361], [43.771514, 11.251279], [43.771517, 11.251266], [43.771586, 11.251027], 
            [43.771635, 11.250887], [43.771681, 11.250759], [43.77175, 11.250682], [43.771836, 11.250708], 
            [43.771866, 11.2507], [43.772236, 11.250611], [43.772627, 11.250516], [43.772652, 11.25051], 
            [43.772665, 11.250508], [43.772948, 11.250465], [43.773029, 11.250439], [43.773268, 11.250271], 
            [43.773441, 11.250201], [43.773583, 11.250144], [43.773581, 11.250179], [43.773592, 11.250173], 
            [43.774176, 11.250026], [43.774198, 11.249934], [43.77467, 11.249856], [43.774665, 11.249823], 
            [43.774801, 11.249803], [43.774908, 11.249819], [43.775046, 11.24984], [43.775139, 11.249793], 
            [43.775204, 11.249731], [43.775247, 11.249671], [43.775265, 11.249627], [43.775275, 11.24958], 
            [43.775281, 11.249425], [43.77529, 11.249118], [43.775293, 11.248966], [43.775352, 11.248969], 
            [43.775397, 11.248972], [43.775405, 11.248973], [43.775428, 11.248975], [43.775437, 11.248975], 
            [43.775466, 11.248977], [43.775507, 11.248944], [43.775537, 11.248942], [43.775569, 11.24894], 
            [43.775589, 11.24897], [43.775754, 11.249213], [43.77578, 11.249253], [43.775823, 11.249317], 
            [43.775849, 11.24934], [43.776069, 11.249237], [43.776198, 11.249178], [43.776226, 11.249165], 
            [43.776155, 11.248885]
];

        const INITIAL_ITINERARY = [
            {
                id: "0",
                title: "Llegada a Puerto Livorno",
                startTime: "07:00",
                endTime: "07:00",
                locationName: "Puerto de Livorno",
                coords: { lat: 43.552781, lng: 10.301391 },
                description: "Llegada del crucero al puerto de Livorno. Inicio de la escala.",
                keyDetails: "Contemplar la maniobra de atraque.",
                type: "logistics",
                completed: false,
                priceEUR: 0
            },
            {
                id: "1",
                title: "Desembarco y llegada al Shuttle",
                startTime: "07:15",
                endTime: "07:30",
                locationName: "Puerto Industrial (Livorno)",
                coords: { lat: 43.552781, lng: 10.301391 },
                description: "Inicio del desembarco en el puerto industrial. Salida inmediata hacia el punto de transporte.",
                keyDetails: "Dirigirse a la zona de autobuses/lanzaderas.",
                type: "logistics",
                completed: false,
                notes: "CRITICAL",
                priceEUR: 0
            },
            {
                id: "2",
                title: "Trayecto en Shuttle MSC",
                startTime: "07:30",
                endTime: "07:45",
                locationName: "Punto de Shuttle (Puerto)",
                endLocationName: "Piazza Municipio",
                coords: { lat: 43.552781, lng: 10.301391 },
                endCoords: { lat: 43.551830, lng: 10.308315 },
                description: "Del muelle a la Piazza del Municipio. Servicio de lanzadera que conecta el barco con el centro de la ciudad.",
                keyDetails: "Servicio oficial de la naviera.",
                priceEUR: 7,
                type: "transport",
                completed: false,
                notes: "BUS"
            },
            {
                id: "3",
                title: "Bus a la Estación",
                startTime: "08:00",
                endTime: "08:10",
                locationName: "Piazza Municipio / Kiosco",
                endLocationName: "Estación de Tren Livorno",
                coords: { lat: 43.55073, lng: 10.30858 },
                endCoords: { lat: 43.554202, lng: 10.33564 },
                description: "Compra de billetes en Kiosco y bus a la estación. Trámite rápido para acceder al transporte público.",
                keyDetails: "Comprar ticket en 'KIOSCO PARA COMPRAR TICKET AUTOBUS' antes de subir.",
                priceEUR: 1.5,
                type: "transport",
                completed: false,
                googleMapsUrl: "https://maps.app.goo.gl/8MQxJ5Ftbaz6sSWd9",
                contingencyNote: "Si el bus tarda, valorar taxi."
            },
            {
                id: "4",
                title: "Tren Regional: Livorno -> Florencia",
                startTime: "08:49",
                endTime: "10:02",
                locationName: "Estación de Tren Livorno",
                endLocationName: "Estación Santa Maria Novella",
                coords: { lat: 43.554202, lng: 10.33564 },
                endCoords: { lat: 43.776539, lng: 11.248277 },
                description: "Trayecto directo a la Estación Sta. Maria Novella. Viaje panorámico a través de la campiña toscana.",
                keyDetails: "Validar billete antes de subir.",
                priceEUR: 12,
                type: "transport",
                completed: false,
                googleMapsUrl: "https://maps.app.goo.gl/w1LYWJrugoicFRzZ8"
            },
            {
                id: "5",
                title: "Capilla Medici y Basílica San Lorenzo",
                startTime: "10:15",
                endTime: "10:30",
                locationName: "Capilla de los Medici",
                coords: { lat: 43.775039, lng: 11.253357 },
                description: "Visita a la obra de Brunelleschi y Miguel Ángel. Mausoleo de la familia Medici y una de las iglesias más antiguas.",
                keyDetails: "Integrado en el conjunto de San Lorenzo. La Capilla de los príncipes destaca.",
                type: "sightseeing",
                completed: false,
                priceEUR: 0,
                audioGuideText: "Integrado en el conjunto de la Basílica de San Lorenzo, en este edificio fueron enterrados los miembros de la familia Medici a partir del siglo XV. La Capilla de los príncipes, destinada a los grandes duques Medici, se construyó el siglo XVII. Esta iglesia fue consagrada el año 393 por San Ambrosio, convirtiéndose de este modo en la más antigua de la ciudad."
            },
            {
                id: "6",
                title: "Galería de la Academia (El David)",
                startTime: "10:40",
                endTime: "11:50",
                locationName: "Galería de la Academia",
                coords: { lat: 43.776901, lng: 11.258696 },
                description: "Hogar del David de Miguel Ángel. Museo que alberga la escultura más famosa del mundo.",
                keyDetails: "REQUIERE RESERVA PREVIA ONLINE.",
                contingencyNote: "COMPRAR PREVIAMENTE LA ENTRADA ONLINE.",
                priceEUR: 24,
                type: "sightseeing",
                completed: false,
                audioGuideText: "Uno de los museos más conocidos de Florencia, sobre todo porque en su interior se conserva el celebérrimo David de Miguel Ángel.",
                bookingUrl: "https://www.galleriaaccademiafirenze.it/es/visit/"
            },
            {
                id: "7",
                title: "Duomo y Baptisterio",
                startTime: "12:00",
                endTime: "12:15",
                locationName: "Plaza del Duomo",
                coords: { lat: 43.773127, lng: 11.255386 },
                description: "Centro religioso de la ciudad. Complejo con la cúpula de Brunelleschi, el Campanile y las puertas del Baptisterio.",
                keyDetails: "Observar la Puerta del Paraíso en el Baptisterio.",
                type: "sightseeing",
                completed: false,
                priceEUR: 0,
                audioGuideText: "Esta plaza es por derecho propio el centro religioso de Florencia. En ella está ubicada la catedral (Duomo), junto al campanile y el baptisterio. Con 155 metros de longitud y 107 metros de altura es una de las catedrales más grandes del mundo. Destaca sobremanera su gran cúpula, sobresaliente en todas las panorámicas de la ciudad."
            },
            {
                id: "8",
                title: "Almuerzo y Souvenirs",
                startTime: "12:20",
                endTime: "12:35",
                locationName: "Zona Centro / Puesto Souvenir",
                coords: { lat: 43.775168, lng: 11.249542 },
                description: "Tiempo para comida y compras.",
                keyDetails: "Breve parada gastronómica.",
                type: "food",
                completed: false,
                priceEUR: 0
            },
            {
                id: "9",
                title: "Piazza della Signoria",
                startTime: "12:35",
                endTime: "12:45",
                locationName: "Piazza della Signoria",
                coords: { lat: 43.769713, lng: 11.255829 },
                description: "Sede del poder civil y museo al aire libre.",
                keyDetails: "Plaza histórica llena de esculturas.",
                type: "sightseeing",
                completed: false,
                priceEUR: 0,
                audioGuideText: "Sede del poder civil de Florencia por los edificios que en ella se encuentran: Palazzo Vecchio, Loggia dei Lanzi o della Signoria, Tribunal de las Mercancías, Palacio Uguccioni o el Palacio de las Aseguraciones Generales."
            },
            {
                id: "10",
                title: "Palazzo Vecchio",
                startTime: "12:45",
                endTime: "13:05",
                locationName: "Palazzo Vecchio",
                coords: { lat: 43.769278, lng: 11.255947 },
                description: "Edificio que representa el poder civil, construido en época medieval.",
                keyDetails: "Visita rápida al patio interior gratuito.",
                type: "sightseeing",
                completed: false,
                priceEUR: 0,
                audioGuideText: "Este edificio ha representado históricamente el poder civil en Florencia. Construido en época medieval alberga actualmente un museo con obras de Bronzino, Giorgio Vasari o Miguel Ángel."
            },
            {
                id: "11",
                title: "Loggia dei Lanzi",
                startTime: "13:05",
                endTime: "13:20",
                locationName: "Loggia dei Lanzi",
                coords: { lat: 43.769244, lng: 11.255556 },
                description: "Pórtico convertido por los Medici en museo al aire libre.",
                keyDetails: "Admirar el Perseo con la cabeza de Medusa.",
                type: "sightseeing",
                completed: false,
                priceEUR: 0,
                audioGuideText: "Construido entre el 1379 y 1381 este pórtico estaba destinado a acoger las asambleas o las distintas ceremonias celebradas en la Piazza della Signoria. Cuando perdió su razón de ser los Medici convirtieron esta Loggia en un museo al aire libre."
            },
            {
                id: "12",
                title: "Puente Vecchio",
                startTime: "13:30",
                endTime: "13:45",
                locationName: "Puente Vecchio",
                coords: { lat: 43.76795, lng: 11.253097 },
                description: "Cruce del río Arno. El puente de piedra medieval más icónico, famoso por sus joyerías.",
                keyDetails: "Cuidado con carteristas en zonas concurridas.",
                type: "sightseeing",
                completed: false,
                priceEUR: 0,
                audioGuideText: "Es uno de los monumentos más visitados de Florencia. Fue reconstruido por completo el año 1345 en piedra y destaca por la gran actividad comercial que se desarrolla sobre él."
            },
            {
                id: "13",
                title: "Palazzo Pitti (Exteriores)",
                startTime: "14:00",
                endTime: "14:25",
                locationName: "Palazzo Pitti",
                coords: { lat: 43.765294, lng: 11.249918 },
                description: "Gran palacio renacentista al otro lado del puente. Antigua residencia de los Grandes Duques.",
                keyDetails: "Visita exterior para admirar la inmensidad del palacio.",
                type: "sightseeing",
                completed: false,
                priceEUR: 0,
                audioGuideText: "Inmenso palacio renacentista. En su interior cohabitan diferentes museos, como la Galería de Arte Moderno, el Museo de la Plata, Galería de trajes, Museo de Carruajes... no obstante destaca entre todos ellos la Galería Palatina, con obras pictóricas de Rafael, Rubens o Tiziano."
            },
            {
                id: "14",
                title: "Regreso a la Estación SMN",
                startTime: "14:25",
                endTime: "15:00",
                locationName: "Palazzo Pitti",
                endLocationName: "Estación Santa Maria Novella",
                coords: { lat: 43.765294, lng: 11.249918 },
                endCoords: { lat: 43.776539, lng: 11.248277 },
                description: "Caminata de retorno hacia la principal terminal ferroviaria.",
                keyDetails: "Llegada con margen para el tren de vuelta.",
                type: "transport",
                completed: false,
                priceEUR: 0
            },
            {
                id: "15",
                title: "Tren Regional: Florencia -> Livorno",
                startTime: "15:26",
                endTime: "16:48",
                locationName: "Estación Santa Maria Novella",
                endLocationName: "Estación de Tren Livorno",
                coords: { lat: 43.776539, lng: 11.248277 },
                endCoords: { lat: 43.554202, lng: 10.33564 },
                description: "Trayecto de vuelta para descansar tras la intensa caminata.",
                keyDetails: "Tiempo de relax antes de la logística final.",
                priceEUR: 12,
                type: "transport",
                completed: false,
                contingencyNote: "El próximo tren no sale hasta dentro de una hora.",
                googleMapsUrl: "https://maps.app.goo.gl/xTqRT8a7fCtDDU6AA"
            },
            {
                id: "16",
                title: "Bus a Shuttle MSC",
                startTime: "17:05",
                endTime: "17:28",
                locationName: "Estación de Tren Livorno",
                endLocationName: "Piazza Municipio",
                coords: { lat: 43.554202, lng: 10.33564 },
                endCoords: { lat: 43.551830, lng: 10.308315 },
                description: "Retorno al muelle de atraque. Tramo final de transporte.",
                keyDetails: "Misma parada que a la ida.",
                priceEUR: 1.5,
                type: "transport",
                completed: false,
                googleMapsUrl: "https://maps.app.goo.gl/w7pZnGYRejacxzUP7"
            },
            {
                id: "17",
                title: "Shuttle a Barco",
                startTime: "17:35",
                endTime: "17:55",
                locationName: "Piazza Municipio",
                endLocationName: "Barco (Puerto)",
                coords: { lat: 43.551830, lng: 10.308315 },
                endCoords: { lat: 43.552781, lng: 10.301391 },
                description: "Último trayecto hacia el barco.",
                keyDetails: "Tener tarjeta de embarque a mano.",
                type: "transport",
                completed: false,
                priceEUR: 0
            },
            {
                id: "18",
                title: "Llegada al Crucero (Límite)",
                startTime: "19:30",
                endTime: "19:30",
                locationName: "Puerto de Livorno",
                coords: { lat: 43.552781, lng: 10.301391 },
                description: "Meta lograda con margen de seguridad.",
                keyDetails: "Tiempo de seguridad recomendado antes del zarpe.",
                type: "logistics",
                completed: false,
                priceEUR: 0
            },
            {
                id: "19",
                title: "Salida del Barco",
                startTime: "20:00",
                endTime: "20:00",
                locationName: "Puerto de Livorno",
                coords: { lat: 43.552781, lng: 10.301391 },
                description: "Hora oficial de zarpe del puerto.",
                keyDetails: "Fin de la escala.",
                type: "logistics",
                completed: false,
                priceEUR: 0
            }
        ];

        const PRONUNCIATIONS = [
            { word: 'Buongiorno', phonetic: "Bwon-jor-no", simplified: 'Bwon-yor-no', meaning: 'Buenos días' },
            { word: 'Grazie', phonetic: "Grat-zye", simplified: 'Grat-sie', meaning: 'Gracias' },
            { word: 'Prego', phonetic: "Pre-go", simplified: 'Pre-go', meaning: 'De nada' },
            { word: 'Per favore', phonetic: "Per fa-vo-re", simplified: 'Por favor', meaning: 'Por favor' },
            { word: 'Dov\'è il bagno?', phonetic: "Do-ve il ba-nyo", simplified: 'Dové il baño', meaning: '¿Dónde está el baño?' },
            { word: 'Il conto, per favore', phonetic: "Il kon-to", simplified: 'La cuenta', meaning: 'La cuenta, por favor' }
        ];

        // --- UTILS ---
        const calculateDuration = (startStr, endStr) => {
            const [startH, startM] = startStr.split(':').map(Number);
            const [endH, endM] = endStr.split(':').map(Number);
            
            let diffMins = (endH * 60 + endM) - (startH * 60 + startM);
            if (diffMins < 0) diffMins += 24 * 60; 

            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;

            if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h`;
            return `${minutes} min`;
        };

        const calculateTimeProgress = (startTime, endTime) => {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            const [startH, startM] = startTime.split(':').map(Number);
            const startMinutes = startH * 60 + startM;

            const [endH, endM] = endTime.split(':').map(Number);
            const endMinutes = endH * 60 + endM;

            if (currentMinutes < startMinutes) return 0;
            if (currentMinutes >= endMinutes) return 100;

            const totalRange = endMinutes - startMinutes;
            const elapsed = currentMinutes - startMinutes;
            
            return Math.min(100, Math.max(0, (elapsed / totalRange) * 100));
        };

        const formatMinutes = (mins) => {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            if (h > 0 && m > 0) return `${h}h ${m}min`;
            if (h > 0) return `${h}h`;
            return `${m}min`;
        };

        // --- COMPONENTS ---

        const Timeline = ({ itinerary, onToggleComplete, onLocate, userLocation, onOpenAudioGuide }) => {
            const [, setTick] = useState(0);

            useEffect(() => {
                const timer = setInterval(() => setTick(t => t + 1), 60000);
                return () => clearInterval(timer);
            }, []);

            const calculateGap = (endStrPrev, startStrNext) => {
                const [endH, endM] = endStrPrev.split(':').map(Number);
                const [startH, startM] = startStrNext.split(':').map(Number);
                const diffMins = (startH * 60 + startM) - (endH * 60 + endM);
                return diffMins > 0 ? diffMins : 0;
            };

            const getStatusColor = (act) => {
                if (act.completed) return 'border-emerald-500 bg-emerald-50 bg-opacity-30';
                if (act.notes === 'CRITICAL') return 'border-amber-500 bg-amber-50';
                return 'border-rose-100 bg-white';
            };

            return (
                <div className="pb-24 px-4 pt-4 max-w-lg mx-auto">
                    <div className="flex justify-between items-end mb-6">
                        <h2 className="text-2xl font-bold text-rose-900 uppercase tracking-tight">Ruta Florencia</h2>
                        <span className="text-[10px] font-black text-rose-400 uppercase tracking-widest bg-rose-50 px-2 py-1 rounded-md border border-rose-100">Sync Online</span>
                    </div>
                    
                    <div className="relative border-l-2 border-stone-200 ml-3 space-y-8">
                        {itinerary.map((act, idx) => {
                            const prevAct = idx > 0 ? itinerary[idx - 1] : null;
                            const gap = prevAct ? calculateGap(prevAct.endTime, act.startTime) : 0;
                            const isCritical = act.notes === 'CRITICAL';
                            const duration = calculateDuration(act.startTime, act.endTime);
                            
                            const actProgress = calculateTimeProgress(act.startTime, act.endTime);
                            const gapProgress = prevAct ? calculateTimeProgress(prevAct.endTime, act.startTime) : 0;
                            
                            return (
                                <React.Fragment key={act.id}>
                                    {gap > 0 && prevAct && (
                                        <div className="relative ml-0 my-8">
                                            <div className="absolute left-[-2px] top-[-20px] bottom-[-20px] border-l-2 border-dashed border-stone-300"></div>
                                            <div className="ml-6 flex items-center">
                                                <div className="bg-stone-50/80 backdrop-blur-sm px-4 py-3 rounded-2xl border border-stone-200 flex flex-col shadow-sm w-full max-w-[240px]">
                                                    <div className="flex items-center mb-2">
                                                        <div className="bg-stone-200 p-1.5 rounded-full mr-3 border border-stone-300">
                                                            <Icons.Clock size={12} className="text-stone-600" />
                                                        </div>
                                                        <div className="flex flex-col">
                                                            <span className="text-[9px] font-black text-stone-400 uppercase tracking-widest leading-none mb-1">Traslado</span>
                                                            <span className="text-[10px] font-bold text-stone-600 uppercase">
                                                                {formatMinutes(gap)} — {gap > 30 ? 'Paseo Libre' : 'Caminata'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div className="w-full h-1 bg-stone-200 rounded-full overflow-hidden">
                                                        <div 
                                                            className="h-full bg-stone-400 transition-all duration-1000" 
                                                            style={{ width: `${gapProgress}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="mb-8 ml-6 relative">
                                        <div 
                                            className={`absolute -left-[31px] top-0 rounded-full bg-white border-2 cursor-pointer transition-all z-10 ${
                                            act.completed ? 'border-emerald-500 text-emerald-500 shadow-sm' : 'border-rose-700 text-rose-700 shadow-sm'
                                            }`}
                                            onClick={() => onToggleComplete(act.id)}
                                        >
                                            {act.completed ? <Icons.CheckCircle2 size={24} /> : <Icons.Circle size={24} />}
                                        </div>

                                        <div className={`rounded-2xl border shadow-sm transition-all overflow-hidden ${getStatusColor(act)} ${act.completed ? 'opacity-70' : 'shadow-md'}`}>
                                            <div className="w-full h-1.5 bg-stone-100 overflow-hidden">
                                                <div 
                                                    className={`h-full transition-all duration-1000 ${actProgress === 100 ? 'bg-stone-300' : 'bg-rose-800'}`} 
                                                    style={{ width: `${actProgress}%` }}
                                                ></div>
                                            </div>

                                            <div className="p-5">
                                                <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className="flex items-center space-x-2 mb-2">
                                                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-rose-100 text-rose-800 tracking-tighter uppercase">
                                                        {act.startTime} - {act.endTime}
                                                        </span>
                                                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-medium bg-stone-100 text-stone-600 border border-stone-200">
                                                        {duration}
                                                        </span>
                                                    </div>
                                                    <h3 className="font-bold text-lg text-stone-800 leading-tight">{act.title}</h3>
                                                </div>
                                                {isCritical && <Icons.AlertTriangle className="text-amber-500 animate-pulse" size={20} />}
                                                </div>

                                                <div className="mb-3 text-sm text-stone-600 flex items-center flex-wrap gap-1">
                                                    <Icons.MapPin size={14} className="mr-0.5 text-rose-700"/> 
                                                    <span className="font-medium">{act.locationName}</span>
                                                    {act.endLocationName && (
                                                        <>
                                                            <Icons.ArrowRight size={12} className="mx-1 text-stone-400" />
                                                            <span className="font-medium">{act.endLocationName}</span>
                                                        </>
                                                    )}
                                                </div>

                                                <p className="text-sm text-stone-600 mb-4 leading-relaxed whitespace-pre-line">{act.description}</p>
                                                
                                                {act.contingencyNote && (
                                                    <div className="bg-amber-50 p-2 rounded-lg text-[10px] text-amber-700 font-bold uppercase tracking-wider mb-3 flex items-center border border-amber-100">
                                                        <Icons.AlertCircle size={12} className="mr-2" />
                                                        {act.contingencyNote}
                                                    </div>
                                                )}

                                                <div className="bg-stone-50 p-3 rounded-xl text-sm text-stone-700 italic border-l-4 border-rose-500 mb-4">
                                                "{act.keyDetails}"
                                                </div>

                                                <div className="flex flex-wrap items-center gap-2 mt-3 pt-4 border-t border-stone-50">
                                                    <button 
                                                        onClick={() => onLocate(act.coords, act.endCoords)}
                                                        className="flex items-center text-[10px] font-bold text-stone-600 bg-stone-100 px-3 py-2 rounded-xl border border-stone-200 hover:bg-stone-200 shadow-sm transition-colors"
                                                    >
                                                        <Icons.Navigation size={12} className="mr-1.5" />
                                                        UBICACIÓN
                                                    </button>

                                                    {act.audioGuideText && (
                                                        <button onClick={() => onOpenAudioGuide(act)} className="flex items-center text-[10px] font-bold text-rose-700 bg-rose-50 px-3 py-2 rounded-xl border border-rose-100 shadow-sm active:bg-rose-100">
                                                            <Icons.Headphones size={12} className="mr-1.5" /> AUDIOGUÍA
                                                        </button>
                                                    )}

                                                    {act.bookingUrl && (
                                                        <a href={act.bookingUrl} target="_blank" rel="noopener noreferrer" className="flex items-center text-[10px] font-bold text-emerald-700 bg-emerald-50 px-3 py-2 rounded-xl border border-emerald-100 hover:bg-emerald-100 shadow-sm transition-colors">
                                                            <Icons.Ticket size={12} className="mr-1.5" /> TICKETS
                                                        </a>
                                                    )}

                                                    {act.googleMapsUrl && (
                                                        <a href={act.googleMapsUrl} target="_blank" rel="noopener noreferrer" className="flex items-center text-[10px] font-bold text-stone-600 bg-white px-3 py-2 rounded-xl border border-stone-200 hover:bg-stone-50 shadow-sm transition-colors">
                                                            <Icons.ExternalLink size={12} className="mr-1.5" /> MAPS
                                                        </a>
                                                    )}
                                                    
                                                    <div className="ml-auto">
                                                        <button
                                                        onClick={() => onToggleComplete(act.id)}
                                                        className={`px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all ${
                                                            act.completed 
                                                            ? 'bg-emerald-100 text-emerald-700 border border-emerald-200' 
                                                            : 'bg-rose-900 text-white shadow-md active:scale-95'
                                                        }`}
                                                        >
                                                        {act.completed ? 'Hecho' : 'Completar'}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </React.Fragment>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Budget = ({ itinerary }) => {
            const COLORS = ['#be123c', '#d97706', '#57534e', '#c2410c'];

            const paidActivities = useMemo(() => itinerary.filter(a => a.priceEUR > 0), [itinerary]);
            
            const total = useMemo(() => {
                return paidActivities.reduce((acc, curr) => acc + curr.priceEUR, 0);
            }, [paidActivities]);

            const chartData = useMemo(() => {
                return paidActivities.map(act => ({
                    name: act.title,
                    value: act.priceEUR
                }));
            }, [paidActivities]);

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-rose-900 flex items-center uppercase tracking-tight">
                        <Icons.Wallet className="mr-2" /> Gastos
                        </h2>
                    </div>

                    <div className="bg-gradient-to-br from-rose-800 to-rose-950 rounded-[2rem] p-6 text-white shadow-xl mb-8 border-2 border-white/10 relative overflow-hidden">
                        <div className="absolute top-[-20px] right-[-20px] w-32 h-32 bg-amber-500/20 rounded-full blur-2xl"></div>
                        <p className="text-rose-100 text-xs mb-1 uppercase tracking-widest font-black opacity-80">Presupuesto Escala</p>
                        <div className="text-4xl font-black">
                        €{total}
                        </div>
                        <p className="text-[10px] text-rose-100 mt-4 flex items-center font-bold uppercase tracking-tighter opacity-70">
                        <Icons.Info size={14} className="mr-1 text-amber-400"/> Incluye trenes y entradas.
                        </p>
                    </div>

                    {paidActivities.length > 0 ? (
                        <>
                        <div className="bg-white rounded-3xl shadow-sm border border-stone-200 mb-8 overflow-hidden">
                            <h3 className="px-5 py-4 border-b border-stone-100 font-black text-xs text-stone-800 uppercase tracking-widest bg-stone-50/50">Desglose Florencia</h3>
                            {paidActivities.map((act, index) => (
                            <div key={act.id} className="flex justify-between items-center p-5 border-b border-stone-100 last:border-0">
                                <div className="flex items-center">
                                <div className="w-2.5 h-2.5 rounded-full mr-3" style={{ backgroundColor: COLORS[index % COLORS.length] }}></div>
                                <div>
                                    <p className="text-sm font-bold text-stone-800">{act.title}</p>
                                    <p className="text-[10px] text-stone-400 uppercase font-black tracking-tighter">{act.type}</p>
                                </div>
                                </div>
                                <div className="font-black text-rose-900">
                                €{act.priceEUR}
                                </div>
                            </div>
                            ))}
                        </div>

                        <div className="h-64 w-full mb-8 bg-white rounded-3xl border border-stone-200 shadow-sm p-4">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                <Pie
                                    data={chartData}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={60}
                                    outerRadius={80}
                                    paddingAngle={8}
                                    dataKey="value"
                                >
                                    {chartData.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} stroke="none" />
                                    ))}
                                </Pie>
                                <Tooltip 
                                    contentStyle={{ borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)', fontFamily: 'inherit', fontWeight: 'bold' }}
                                />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                        </>
                    ) : (
                        <div className="p-12 text-center bg-stone-50 rounded-[2.5rem] border-2 border-dashed border-stone-200 mb-8">
                        <Icons.Wallet className="mx-auto text-stone-300 mb-4" size={32} />
                        <p className="text-stone-400 font-bold uppercase tracking-widest text-xs">Sin gastos previstos</p>
                        </div>
                    )}

                    <div className="bg-amber-50 border border-amber-100 rounded-3xl p-5 flex items-start shadow-sm mb-12">
                        <Icons.TrendingDown className="text-amber-600 mt-1 mr-4 flex-shrink-0" size={20} />
                        <div>
                        <h4 className="font-black text-amber-800 text-xs uppercase tracking-widest">Consejo Florencia</h4>
                        <p className="text-xs text-amber-700 mt-1 font-medium leading-relaxed">
                            Compra los billetes de tren con antelación para evitar colas en las máquinas de la estación de Livorno.
                        </p>
                        </div>
                    </div>
                </div>
            );
        };

        const Guide = ({ userLocation }) => {
            const [playing, setPlaying] = useState(null);
            const [weather, setWeather] = useState(null);
            const [loadingWeather, setLoadingWeather] = useState(true);

            useEffect(() => {
                const fetchWeather = async () => {
                try {
                    const response = await fetch(
                    'https://api.open-meteo.com/v1/forecast?latitude=43.77&longitude=11.25&hourly=temperature_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe%2FRome'
                    );
                    const data = await response.json();
                    setWeather({
                    hourly: {
                        time: data.hourly.time,
                        temperature: data.hourly.temperature_2m,
                        code: data.hourly.weathercode
                    },
                    daily: {
                        time: data.daily.time,
                        weathercode: data.daily.weathercode,
                        temperature_2m_max: data.daily.temperature_2m_max,
                        temperature_2m_min: data.daily.temperature_2m_min
                    }
                    });
                } catch (error) {
                    console.error("Clima error:", error);
                } finally {
                    setLoadingWeather(false);
                }
                };
                fetchWeather();
            }, []);

            const getWeatherIcon = (code, size = 20) => {
                if (code <= 1) return <Icons.Sun size={size} className="text-amber-500" />;
                if (code <= 3) return <Icons.Cloud size={size} className="text-stone-400" />;
                if (code <= 67) return <Icons.CloudRain size={size} className="text-blue-500" />;
                if (code <= 99) return <Icons.CloudLightning size={size} className="text-purple-500" />;
                return <Icons.Wind size={size} className="text-stone-400" />;
            };

            const playSimulatedAudio = (word) => {
                if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'it-IT';
                utterance.rate = 0.85;
                setPlaying(word);
                utterance.onend = () => setPlaying(null);
                window.speechSynthesis.speak(utterance);
                }
            };

            const handleSOS = () => {
                const message = userLocation 
                ? `¡SOS! Necesito ayuda en Florencia. Mi ubicación actual es: https://maps.google.com/?q=${userLocation.lat},${userLocation.lng}`
                : `¡SOS! Necesito ayuda en Florencia. No puedo obtener mi ubicación GPS.`;
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            };

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return new Intl.DateTimeFormat('es-ES', { weekday: 'short', day: 'numeric' }).format(date);
            };

            const visitSummary = {
                totalWindow: "12h 45min",
                sightseeingTime: "5h 30min",
                logisticsTime: "7h 15min",
                estimatedDistance: "7.5 km",
                stepsApprox: "~10.500",
                poiCount: 19,
                accessibility: "Media (Empedrado)"
            };

            return (
                <div className="pb-32 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto no-scrollbar">
                <h2 className="text-2xl font-bold text-rose-900 mb-6 uppercase tracking-tight">Guía Florencia</h2>

                <div className="mb-8 bg-white rounded-[2rem] border border-rose-100 shadow-md p-6 overflow-hidden relative">
                    <div className="flex items-center gap-2 mb-4">
                    <Icons.Activity size={18} className="text-rose-700" />
                    <h3 className="text-xs font-black text-stone-800 uppercase tracking-widest">Resumen de la Visita</h3>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-y-5 gap-x-4">
                    <div className="flex flex-col">
                        <span className="text-[9px] font-bold text-stone-400 uppercase tracking-tighter mb-1">Escala Total</span>
                        <div className="flex items-center gap-1.5">
                        <Icons.Clock size={14} className="text-rose-600" />
                        <span className="text-sm font-black text-rose-950">{visitSummary.totalWindow}</span>
                        </div>
                    </div>
                    <div className="flex flex-col">
                        <span className="text-[9px] font-bold text-stone-400 uppercase tracking-tighter mb-1">Turismo Activo</span>
                        <div className="flex items-center gap-1.5">
                        <Icons.Sun size={14} className="text-amber-500" />
                        <span className="text-sm font-black text-rose-950">{visitSummary.sightseeingTime}</span>
                        </div>
                    </div>
                    <div className="flex flex-col">
                        <span className="text-[9px] font-bold text-stone-400 uppercase tracking-tighter mb-1">Distancia a pie</span>
                        <div className="flex items-center gap-1.5">
                        <Icons.Activity size={14} className="text-emerald-600" />
                        <span className="text-sm font-black text-rose-950">{visitSummary.estimatedDistance}</span>
                        </div>
                    </div>
                    <div className="flex flex-col">
                        <span className="text-[9px] font-bold text-stone-400 uppercase tracking-tighter mb-1">Pasos aprox.</span>
                        <div className="flex items-center gap-1.5">
                        <Icons.Footprints size={14} className="text-stone-600" />
                        <span className="text-sm font-black text-rose-950">{visitSummary.stepsApprox}</span>
                        </div>
                    </div>
                    </div>

                    <div className="mt-6 pt-4 border-t border-stone-50 flex justify-between items-center text-[9px] font-bold uppercase text-stone-500">
                    <span>{visitSummary.poiCount} Puntos de Interés</span>
                    <span className="bg-amber-50 text-amber-700 px-2 py-0.5 rounded-full border border-amber-100">{visitSummary.accessibility}</span>
                    </div>
                </div>

                <div className="mb-8 bg-rose-900 rounded-[2rem] p-6 shadow-xl text-white relative overflow-hidden border-2 border-white/10">
                    <div className="absolute top-[-20px] right-[-20px] w-32 h-32 bg-rose-500/20 rounded-full blur-2xl"></div>
                    <div className="relative z-10">
                    <div className="flex items-center mb-3">
                        <Icons.PhoneCall size={24} className="text-white animate-pulse mr-3" />
                        <h3 className="font-black text-lg uppercase tracking-widest">ASISTENCIA SOS</h3>
                    </div>
                    <p className="text-xs text-rose-100 mb-6 leading-relaxed font-medium">
                        Si pierdes el tren o te desorientas en Florencia, envía tu ubicación. El último tren seguro sale a las 16:48.
                    </p>
                    <button onClick={handleSOS} className="w-full py-4 bg-white text-rose-900 font-black rounded-2xl flex items-center justify-center gap-2 shadow-lg uppercase tracking-widest text-sm active:scale-95 transition-transform">
                        <Icons.Send size={18} /> Enviar Localización
                    </button>
                    </div>
                </div>

                <div className="mb-8">
                    <h3 className="text-sm font-black text-stone-800 mb-4 flex items-center uppercase tracking-widest px-1">
                    <Icons.Thermometer size={18} className="mr-2 text-rose-900"/> Tiempo en Florencia
                    </h3>
                    
                    {loadingWeather ? (
                    <div className="h-24 bg-white rounded-3xl animate-pulse border border-rose-100"></div>
                    ) : (
                    <>
                        <div className="bg-white p-2 pb-5 rounded-[2.5rem] border border-rose-100 shadow-xl overflow-hidden mb-4">
                        <h4 className="text-[10px] font-black text-rose-300 uppercase tracking-widest text-center mt-2 mb-2">Hoy</h4>
                        <div className="flex overflow-x-auto gap-3 px-6 py-2 no-scrollbar">
                            {weather?.hourly.time.map((time, i) => {
                            const hour = new Date(time).getHours();
                            if (hour >= 8 && hour <= 20) return (
                                <div key={time} className="flex flex-col items-center justify-between min-w-[70px] p-3 bg-rose-50/50 rounded-3xl border border-rose-100">
                                <span className="text-[10px] font-black text-rose-400 mb-2">{hour}:00</span>
                                <div className="p-2 bg-white rounded-2xl mb-2 shadow-sm">{getWeatherIcon(weather.hourly.code[i], 24)}</div>
                                <span className="text-sm font-black text-rose-900">{Math.round(weather.hourly.temperature[i])}°</span>
                                </div>
                            );
                            return null;
                            })}
                        </div>
                        </div>

                        <div className="bg-white rounded-[2rem] border border-rose-100 shadow-lg p-5">
                        <div className="flex items-center gap-2 mb-4 px-1">
                            <Icons.CalendarDays size={16} className="text-rose-500" />
                            <span className="text-[10px] font-black text-stone-400 uppercase tracking-widest">Próximos 5 días</span>
                        </div>
                        <div className="space-y-1">
                            {weather?.daily.time.slice(0, 5).map((day, i) => (
                            <div key={day} className="flex items-center justify-between p-3 hover:bg-stone-50 rounded-xl transition-colors">
                                <span className="w-16 text-xs font-bold text-stone-600 capitalize">{formatDate(day)}</span>
                                <div className="flex items-center gap-3">
                                {getWeatherIcon(weather.daily.weathercode[i], 18)}
                                </div>
                                <div className="flex items-center gap-3 w-20 justify-end">
                                <span className="text-xs font-bold text-stone-800">{Math.round(weather.daily.temperature_2m_max[i])}°</span>
                                <span className="text-xs font-medium text-stone-400">{Math.round(weather.daily.temperature_2m_min[i])}°</span>
                                </div>
                            </div>
                            ))}
                        </div>
                        </div>
                    </>
                    )}
                </div>

                <h3 className="text-sm font-black text-stone-800 mb-4 flex items-center uppercase tracking-widest px-1">
                    <Icons.Languages size={18} className="mr-2 text-rose-900"/> Italiano Básico
                </h3>
                <div className="bg-white rounded-3xl shadow-md border border-rose-50 overflow-hidden mb-8">
                    {PRONUNCIATIONS.map((item) => (
                    <div key={item.word} className="p-5 flex justify-between items-center border-b border-stone-50 last:border-0 hover:bg-rose-50/30 transition-colors group">
                        <div>
                        <div className="flex items-center gap-3">
                            <p className="font-black text-rose-950 text-lg">{item.word}</p>
                            <button onClick={() => playSimulatedAudio(item.word)} className={`p-2 rounded-full transition-all ${playing === item.word ? 'bg-rose-100 text-rose-700' : 'bg-stone-100 text-stone-400 group-hover:bg-rose-50'}`}>
                            <Icons.Volume2 size={16} />
                            </button>
                        </div>
                        <p className="text-xs text-stone-500 italic">"{item.simplified}"</p>
                        </div>
                        <p className="text-[10px] font-black text-rose-500 bg-rose-50 px-3 py-1 rounded-full uppercase tracking-tighter border border-rose-100">{item.meaning}</p>
                    </div>
                    ))}
                </div>
                </div>
            );
        };

        const MapComponent = ({ activities, userLocation, focusedLocation }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layersRef = useRef([]);

            useEffect(() => {
                if (!mapContainerRef.current || mapInstanceRef.current) return;
                const map = L.map(mapContainerRef.current, { zoomControl: false }).setView([43.7731, 11.2553], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    maxZoom: 18,
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);
                mapInstanceRef.current = map;
                return () => {
                    map.remove();
                    mapInstanceRef.current = null;
                };
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;
                layersRef.current.forEach(layer => layer.remove());
                layersRef.current = [];

                const defaultIcon = L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                });

                activities.forEach(act => {
                    const marker = L.marker([act.coords.lat, act.coords.lng], { icon: defaultIcon }).addTo(map);
                    marker.bindPopup(`
                        <div style="padding: 10px; font-family: 'Roboto Condensed', sans-serif;">
                        <h3 style="margin: 0; font-weight: bold; color: #881337;">${act.title}</h3>
                        <p style="margin: 4px 0 0 0; font-size: 11px; color: #57534e;">${act.locationName}</p>
                        </div>
                    `);
                    layersRef.current.push(marker);
                });

                GPX_WAYPOINTS.forEach(wpt => {
                    const circleMarker = L.circleMarker([wpt.lat, wpt.lng], {
                        radius: 6,
                        fillColor: "#be123c",
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    circleMarker.bindPopup(`<div style="font-size: 12px; font-weight: bold; color: #be123c;">${wpt.name}</div>`);
                    layersRef.current.push(circleMarker);
                });

                if (FLORENCE_WALK_TRACK.length > 0) {
                    const trackLine = L.polyline(FLORENCE_WALK_TRACK, {
                        color: '#be123c',
                        weight: 4,
                        opacity: 0.8,
                        dashArray: '8, 12'
                    }).addTo(map);
                    layersRef.current.push(trackLine);
                }

                if (userLocation) {
                    const userIcon = L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background-color: #0ea5e9; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(14,165,233,0.5);"></div>',
                        iconSize: [18, 18]
                    });
                    const marker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map);
                    layersRef.current.push(marker);
                }
            }, [activities, userLocation]);

            useEffect(() => {
                if (mapInstanceRef.current && focusedLocation) {
                    mapInstanceRef.current.flyTo([focusedLocation.lat, focusedLocation.lng], 16);
                }
            }, [focusedLocation]);

            return <div ref={mapContainerRef} className="w-full h-full z-0" />;
        };

        const STORAGE_KEY = 'florence_guide_v1_storage';

        const App = () => {
            const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
            const [activeTab, setActiveTab] = useState('timeline');
            const [userLocation, setUserLocation] = useState(null);
            const [mapFocus, setMapFocus] = useState(null);
            const [countdown, setCountdown] = useState('00h 00m 00s');
            
            const [audioGuideActivity, setAudioGuideActivity] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);

            useEffect(() => {
                const loader = document.getElementById('initial-loader');
                if (loader) {
                    setTimeout(() => {
                        loader.style.opacity = '0';
                        setTimeout(() => loader.remove(), 500);
                    }, 500);
                }

                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        const merged = INITIAL_ITINERARY.map(initItem => {
                        const savedItem = parsed.find((p) => p.id === initItem.id);
                        return savedItem ? { ...initItem, completed: savedItem.completed } : initItem;
                        });
                        setItinerary(merged);
                    }
                } catch (e) {
                    console.warn("Storage fallido", e);
                }
            }, []);

            const handleToggleComplete = (id) => {
                const newItinerary = itinerary.map(act => 
                    act.id === id ? { ...act, completed: !act.completed } : act
                );
                setItinerary(newItinerary);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(newItinerary));
            };

            useEffect(() => {
                if ('geolocation' in navigator) {
                    const watchId = navigator.geolocation.watchPosition(
                        (pos) => setUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                        (err) => console.log("GPS no disponible", err),
                        { enableHighAccuracy: true }
                    );
                    return () => navigator.geolocation.clearWatch(watchId);
                }
            }, []);

            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    const [hours, minutes] = SHIP_ONBOARD_TIME.split(':').map(Number);
                    const target = new Date();
                    target.setHours(hours, minutes, 0, 0);
                    const diff = target.getTime() - now.getTime();
                    
                    if (diff <= 0) {
                        setCountdown("¡A BORDO!");
                    } else {
                        const h = Math.floor(diff / (1000 * 60 * 60));
                        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const s = Math.floor((diff % (1000 * 60)) / 1000);
                        setCountdown(`${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`);
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            const handleLocate = (coords) => {
                setMapFocus(coords);
                setActiveTab('map');
            };

            const handlePlayAudio = () => {
                if (!audioGuideActivity?.audioGuideText) return;
                
                if (isPlaying) {
                    window.speechSynthesis.cancel();
                    setIsPlaying(false);
                } else {
                    const utterance = new SpeechSynthesisUtterance(audioGuideActivity.audioGuideText);
                    utterance.lang = 'es-ES';
                    utterance.rate = 0.95;
                    utterance.onend = () => setIsPlaying(false);
                    window.speechSynthesis.speak(utterance);
                    setIsPlaying(true);
                }
            };

            return (
                <div className="flex flex-col h-screen bg-stone-50 text-stone-900 font-sans overflow-hidden">
                    <header className="bg-rose-900 text-white p-4 shadow-xl z-20 flex justify-between items-center shrink-0 border-b border-rose-800">
                        <div className="flex items-center">
                        <Icons.Anchor className="mr-3 text-amber-400" size={24} />
                        <div>
                            <h1 className="font-black text-[10px] uppercase tracking-[0.2em] text-rose-200">Escala Florencia</h1>
                            <p className="text-[12px] font-bold text-white/95 leading-tight">15 Abril 2026</p>
                        </div>
                        </div>
                        <div className="flex flex-col items-end">
                        <span className="text-[8px] font-black uppercase text-amber-400 tracking-widest mb-0.5">Cuenta atrás</span>
                        <div className="text-lg font-black font-mono text-white leading-none tracking-tighter">{countdown}</div>
                        </div>
                    </header>

                    <main className="flex-1 overflow-hidden relative">
                        {activeTab === 'timeline' && (
                        <div className="h-full overflow-y-auto no-scrollbar">
                            <Timeline 
                            itinerary={itinerary} 
                            onToggleComplete={handleToggleComplete}
                            onLocate={handleLocate}
                            userLocation={userLocation}
                            onOpenAudioGuide={(act) => setAudioGuideActivity(act)}
                            />
                        </div>
                        )}
                        
                        {activeTab === 'map' && (
                        <MapComponent 
                            activities={itinerary} 
                            userLocation={userLocation}
                            focusedLocation={mapFocus}
                        />
                        )}

                        {activeTab === 'budget' && <Budget itinerary={itinerary} />}
                        {activeTab === 'guide' && <Guide userLocation={userLocation} />}

                        {audioGuideActivity && (
                        <div className="absolute inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-rose-950/60 backdrop-blur-sm animate-in fade-in duration-200">
                            <div className="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-in slide-in-from-bottom-8 duration-300">
                            <div className="p-8">
                                <div className="flex justify-between items-start mb-6">
                                <div className="bg-rose-100 p-3 rounded-2xl border border-rose-200">
                                    <Icons.Headphones size={24} className="text-rose-700" />
                                </div>
                                <button onClick={() => { window.speechSynthesis.cancel(); setIsPlaying(false); setAudioGuideActivity(null); }} className="text-stone-300 hover:text-stone-600 transition-colors">
                                    <Icons.X size={28} />
                                </button>
                                </div>
                                
                                <h3 className="text-xs font-black text-rose-400 uppercase tracking-[0.2em] mb-2">Audioguía</h3>
                                <h4 className="text-xl font-black text-stone-800 mb-6 leading-tight">{audioGuideActivity.title}</h4>
                                
                                <div className="max-h-[300px] overflow-y-auto pr-2 custom-h-scrollbar mb-8">
                                <p className="text-stone-600 leading-relaxed font-medium italic">
                                    {audioGuideActivity.audioGuideText}
                                </p>
                                </div>

                                <div className="flex gap-4">
                                <button 
                                    onClick={handlePlayAudio}
                                    className={`flex-1 flex items-center justify-center gap-3 py-4 rounded-3xl font-black uppercase tracking-widest text-sm transition-all shadow-lg active:scale-95 ${
                                    isPlaying ? 'bg-amber-600 text-white shadow-amber-200' : 'bg-rose-900 text-white shadow-rose-200'
                                    }`}
                                >
                                    {isPlaying ? <Icons.Square size={18} fill="white" /> : <Icons.Play size={18} fill="white" />}
                                    {isPlaying ? 'Detener' : 'Escuchar'}
                                </button>
                                </div>
                            </div>
                            </div>
                        </div>
                        )}
                    </main>

                    <nav className="bg-white/95 backdrop-blur-md border-t border-stone-100 z-30 shrink-0 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                        <div className="flex justify-around items-center h-20 px-2 pb-safe">
                        {[
                            { id: 'timeline', icon: Icons.CalendarClock, label: 'Itinerario' },
                            { id: 'map', icon: Icons.Map, label: 'Mapa' },
                            { id: 'budget', icon: Icons.Wallet, label: 'Gastos' },
                            { id: 'guide', icon: Icons.BookOpen, label: 'Guía' }
                        ].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-full justify-center transition-all ${activeTab === tab.id ? 'text-rose-800' : 'text-stone-400'}`}>
                            <div className={`p-2 rounded-xl mb-1 ${activeTab === tab.id ? 'bg-rose-50 shadow-sm' : ''}`}>
                                <tab.icon size={22} />
                            </div>
                            <span className="text-[9px] font-black uppercase tracking-widest">{tab.label}</span>
                            </button>
                        ))}
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
